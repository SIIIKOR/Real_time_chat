{% extends 'chat_app/sub_base.html' %}

{% block 'sub_contents' %}
<h1>{{room_name}}</h1>

<textarea id="chat-text" cols="80" rows="30"></textarea>
<input id="input" type="text" size="80">
<input id="submit" type="button" value="Send">

{{room_name|json_script:"room-name"}}
{{user.user_name|json_script:"user-username"}}
<script>
    const roomName = JSON.parse(
        document.getElementById("room-name").textContent
    );

    const userUsername = JSON.parse(
        document.getElementById("user-username").textContent
    );

    const chatSocket = new WebSocket(
        "ws://" +
        window.location.host +
        "/ws/chat/" +
        roomName +
        "/"
    );

    chatSocket.onmessage = function (event) {
        const data = JSON.parse(event.data);
        document.querySelector("#chat-text").value += (
            data.user_name + ": " + data.message + "\n"
        );
    }

    document.querySelector("#submit").onclick = function (event) {
        const messageInputDom = document.querySelector("#input");
        const message = messageInputDom.value;
        chatSocket.send(
            JSON.stringify(
                {
                    "message": message,
                    "user_name": userUsername
                }
            )
        );
        messageInputDom.value = "";
    }
</script>

{% endblock %}